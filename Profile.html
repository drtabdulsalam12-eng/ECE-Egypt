<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨ÙŠ - ECE Egypt</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .profile-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #17a2b8 0%, #0c5460 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }
        .edit-profile-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #17a2b8;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .edit-profile-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        .user-avatar-container {
            margin-bottom: 15px;
        }
        .user-avatar {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            object-fit: cover;
            background: white;
            display: inline-block;
        }
        .profile-header h1 {
            margin: 10px 0;
        }
        .profile-header p {
            margin: 5px 0;
            opacity: 0.9;
        }
        .trust-score {
            font-size: 24px;
            font-weight: bold;
            margin-top: 15px;
        }
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .profile-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .profile-card h3 {
            color: #17a2b8;
            margin-bottom: 15px;
            border-bottom: 2px solid #17a2b8;
            padding-bottom: 10px;
        }
        .profile-field {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .profile-field label {
            font-weight: 600;
            color: #333;
        }
        .profile-field value {
            color: #666;
        }
        .profile-field value.empty {
            color: #999;
            font-style: italic;
        }
        .skills-list, .languages-list, .certificates-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .skill-tag, .language-tag, .certificate-tag {
            background: #e8f4f8;
            color: #17a2b8;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid #17a2b8;
        }
        .language-tag {
            background: #fff3cd;
            color: #856404;
            border-color: #856404;
        }
        .certificate-tag {
            background: #d4edda;
            color: #155724;
            border-color: #155724;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
            text-align: center;
            text-decoration: none;
        }
        .btn-primary {
            background: #17a2b8;
            color: white;
        }
        .btn-primary:hover {
            background: #138496;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div id="loadingMessage" class="loading">
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>

        <div id="errorMessage" style="display: none;"></div>

        <div id="profileContent" style="display: none;">
            <div class="profile-header">
                <a href="Edit_Profile.html" class="edit-profile-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a>
                <div class="user-avatar-container">
                    <img id="userAvatar" src="images/default-avatar.png" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©" class="user-avatar">
                </div>
                <h1 id="userName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h1>
                <p id="userEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</p>
                <p id="userPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</p>
                <div style="font-size: 16px; margin-top: 15px;">
                    ğŸ’¬ <a href="mailto:dr.t.abdulsalam12@gmail.com" style="color: white; text-decoration: none; margin-left: 10px;">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
                </div>
                <p style="font-size: 14px; margin-top: 10px; opacity: 0.9;">â° Ø§Ù„Ø£Ø­Ø¯ - Ø§Ù„Ø®Ù…ÙŠØ³: 10 Øµ - 6 Ù…</p>
            </div>

            <div class="profile-grid">
                <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                <div class="profile-card">
                    <h3>ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    <div class="profile-field">
                        <label>Ø§Ù„Ø¬Ù†Ø³:</label>
                        <value id="userGender">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯:</label>
                        <value id="userPostalCode">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
                        <value id="userGovernorate">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:</label>
                        <value id="userResidence">-</value>
                    </div>
                </div>

                <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© -->
                <div class="profile-card">
                    <h3>ğŸ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
                    <div class="profile-field">
                        <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                        <value id="userEducation">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©:</label>
                        <value id="userUniversity">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©:</label>
                        <value id="userHighSchool">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø§Ù„ØªØ®ØµØµ:</label>
                        <value id="userFieldOfStudy">-</value>
                    </div>
                </div>

                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© -->
                <div class="profile-card">
                    <h3>ğŸ’¼ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
                    <div class="profile-field">
                        <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…Ø±ØºÙˆØ¨:</label>
                        <value id="userSalary">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
                        <value id="userWorkFrom">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
                        <value id="userWorkTo">-</value>
                    </div>
                    <div class="profile-field">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª:</label>
                        <value id="userWorkHours">-</value>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª -->
            <div class="profile-card">
                <h3>ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</h3>
                <div id="skillsList" class="skills-list">
                    <span class="empty">Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ù…Ù‡Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</span>
                </div>
            </div>

            <!-- Ø§Ù„Ù„ØºØ§Øª -->
            <div class="profile-card">
                <h3>ğŸŒ Ø§Ù„Ù„ØºØ§Øª</h3>
                <div id="languagesList" class="languages-list">
                    <span class="empty">Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ù„ØºØ§Øª Ø¨Ø¹Ø¯</span>
                </div>
            </div>

            <!-- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª -->
            <div class="profile-card">
                <h3>ğŸ“œ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª (PDF)</h3>
                <div id="certificatesList" class="certificates-list">
                    <span class="empty">Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ø´Ù‡Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯</span>
                </div>
            </div>

            <div class="btn-group">
                <a href="Search.html" class="btn btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø­Ø«</a>
                <button class="btn btn-secondary" onclick="window.history.back()">Ø±Ø¬ÙˆØ¹</button>
                <button id="deleteAccountBtn" class="btn btn-danger">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const token = localStorage.getItem('token');
                const userEmail = localStorage.getItem('userEmail');
                
                if (!token || !userEmail) {
                    showError('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                    setTimeout(() => window.location.href = 'Auth.html', 2000);
                    return;
                }

                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµØ­ÙŠØ­
                const response = await fetch(`/api/users/profile-by-token`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success) {
                    showError(data.message || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }

                displayProfile(data.user);
                setupDeleteAccount(token);
            } catch (error) {
                console.error('Error:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        });

        function displayProfile(user) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

            // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
            if (user.avatar) {
                document.getElementById('userAvatar').src = user.avatar;
            }

            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            document.getElementById('userName').textContent = user.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('userEmail').textContent = user.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('userPhone').textContent = user.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            

            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
            document.getElementById('userGender').textContent = getGenderText(user.gender);
            document.getElementById('userPostalCode').textContent = user.postalCode || user.postal_code || '-';
            document.getElementById('userGovernorate').textContent = user.governorate || '-';
            document.getElementById('userResidence').textContent = user.residence || '-';

            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©
            document.getElementById('userEducation').textContent = user.educationLevel || '-';
            document.getElementById('userUniversity').textContent = user.college || '-';
            document.getElementById('userHighSchool').textContent = user.highSchool || '-';
            document.getElementById('userFieldOfStudy').textContent = user.fieldOfStudy || '-';

            // ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ©
            document.getElementById('userSalary').textContent = user.desiredSalary ? `${user.desiredSalary} Ø¬Ù†ÙŠÙ‡` : '-';
            document.getElementById('userWorkFrom').textContent = user.workFrom || '-';
            document.getElementById('userWorkTo').textContent = user.workTo || '-';
            document.getElementById('userWorkHours').textContent = user.workHours ? `${user.workHours} Ø³Ø§Ø¹Ø§Øª` : '-';

            // Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª
            const skillsList = document.getElementById('skillsList');
            if (user.skills && user.skills.length > 0) {
                skillsList.innerHTML = user.skills
                    .map(skill => `<span class="skill-tag">${skill}</span>`)
                    .join('');
            }

            // Ø§Ù„Ù„ØºØ§Øª
            const languagesList = document.getElementById('languagesList');
            if (user.languages && user.languages.length > 0) {
                languagesList.innerHTML = user.languages
                    .map(lang => {
                        // ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù„ØºØ© ÙƒØ§Ø¦Ù† Ø£Ùˆ Ù†Øµ
                        const name = typeof lang === 'string' ? lang : (lang.name || lang);
                        const level = (lang && lang.proficiency_level) ? ` (${lang.proficiency_level})` : '';
                        return `<span class="language-tag">${name}${level}</span>`;
                    })
                    .join('');
            }

            // Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª
            const certificatesList = document.getElementById('certificatesList');
            if (user.certificates && user.certificates.length > 0) {
                certificatesList.innerHTML = user.certificates
                    .map(cert => {
                        const name = cert.name || cert;
                        const link = cert.fileUrl || '#';
                        return `<a href="${link}" target="_blank" class="certificate-tag">ğŸ“„ ${name}</a>`;
                    })
                    .join('');
            }
        }

        function setupDeleteAccount(token) {
            document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
                if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„ÙØ¹Ù„.')) {
                    try {
                        const response = await fetch('/api/users/me', {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const data = await response.json();
                        if (data.success) {
                            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                            localStorage.clear();
                            window.location.href = 'Auth.html';
                        } else {
                            alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨');
                    }
                }
            });
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function getGenderText(gender) {
            const map = { 'male': 'Ø°ÙƒØ±', 'female': 'Ø£Ù†Ø«Ù‰' };
            return map[gender] || '-';
        }
    </script>
</body>
</html>
